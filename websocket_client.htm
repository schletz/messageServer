<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style type="text/css">
        p {
            margin:0px;
        }
        h1 { 
            font-size:12pt;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" type="text/javascript"></script>

    <script type="text/javascript">
        var site = {
            httpserverUrl: "https://localhost:25221",
            websocketUrl: "ws://localhost:25222/messageserver",
            authUser: {},

            sendLogin: function () {
                var username = document.getElementById("username").value;
                var password = document.getElementById("passwort").value;

                $.post
                ({
                    url: site.httpserverUrl+"/auth",
                    dataType: "json",
                    data: {user: username, pass: password},
                    success: function (response) {
                        site.appendLog(response);     
                                                        
                        if (typeof response.token === "string") {
                            site.authUser.name = username;
                            site.authUser.token = response.token;
                            site.authUser.websocketKey = response.websocketKey;
                            site.createWebsocket();
                        }
                        else {
                            site.authUser = {};
                        }
                    },
                    error: function(msg) {
                        site.appendLog(msg);
                    }
                });
            },

            sendMessage: function() {
                var message = document.getElementById("message").value;
                $.post
                ({
                    url: site.httpserverUrl+"/sendMessage",
                    dataType: "json",
                    data: {token: site.authUser.token, message: message},
                    success: function (response) {
                        site.appendLog(response);                           
                    }
                });                
            },
            
            appendMessage: function(data) {
                $("#messages").append("<p>"+data.autor+": " + data.message + "</p>");
            },

            appendLog: function(data) {
                var now = new Date();
                var message = typeof data === "object" ? JSON.stringify(data) : data.toString();
                $("#log").append("<p>" + now.toISOString() + ": " + JSON.stringify(data) + "</p>");
            },

            createWebsocket: function() {
                var ws = new WebSocket(site.websocketUrl+"/"+site.authUser.websocketKey);
                ws.onerror = function (err) {
                    site.appendLog(err.data);   
                };
                ws.onmessage = function (event) {
                    site.appendMessage(JSON.parse(event.data));
                };
            }
        };

    </script>
</head>
<body>
    <div id="login">
    <form action="#">
        <h1>Benutzerlogin</h1>
        <p>Verwende Max mit Passwort 1234 oder Moritz mit Passwort 4321.</p>
        <table>
            <tr><td>Username:</td><td><input type="text" size="20" name="username" id="username" value="Max"/></td></tr>
            <tr><td>Passwort:</td><td><input type="text" size="20" name="passwort" id="passwort" value="1234" /></td></tr> 
            <tr><td>&nbsp;</td>   <td><a href="#" onclick="site.sendLogin()">Anmelden</a></td></tr>
        </table>
    </form>        
    </div>

    <div id="messages">
        <h1>Nachrichten</h1>
        <p>Neue Nachricht: <input type="text" size="40" name="message" id="message"/><button value="Senden" onclick="site.sendMessage()">Senden</button></p>     
    </div>

    <div id="log">
        <h1>Serverlog</h1>
    </div>
</body>
</html>